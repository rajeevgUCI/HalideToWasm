<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>HalideToWasm</title>
    <meta name="description" content="HalideToWasm demo">
</head>
<body>
    <div>
        <p>Open JavaScript console to view output.</p>
    </div>
    <div>
        <canvas id="canvas-image-src" width="512" height="512"></canvas>
        <canvas id="canvas-image-out" width="512" height="512"></canvas>
    </div>
    <div>
        <a title="Rob Mitchell [CC0], via Wikimedia Commons" href="https://commons.wikimedia.org/wiki/File:Foden_truck_(15260849919).jpg">Image Source: Rob Mitchell [CC0], via Wikimedia Commons</a>
    </div>
<script>
function halide_myfunc(Module, halideBuf, width, height) {
    Module.print("In JS");

    Module.print(`halideBuf address = 0x${halideBuf.toString(16)}`);

    let custom_halide_downgrade_buffer_t = Module.cwrap('custom_halide_downgrade_buffer_t', 'number', ['number', 'number', 'number', 'number']);
    let custom_halide_downgrade_buffer_t_device_fields = Module.cwrap('custom_halide_downgrade_buffer_t_device_fields', 'number', ['number', 'number', 'number', 'number']);
    let custom_halide_error_bad_type = Module.cwrap('custom_halide_error_bad_type', 'number', ['number', 'number', 'number', 'number', 'number', 'number', 'number', 'number']);
    let custom_halide_error_buffer_allocation_too_large = Module.cwrap('custom_halide_error_buffer_allocation_too_large', 'number', ['number', 'number', 'number', 'number']);
    let custom_halide_error_buffer_argument_is_null = Module.cwrap('custom_halide_error_buffer_argument_is_null', 'number', ['number', 'number']);
    let custom_halide_error_buffer_extents_negative = Module.cwrap('custom_halide_error_buffer_extents_negative', 'number', ['number', 'number', 'number', 'number']);
    let custom_halide_error_buffer_extents_too_large = Module.cwrap('custom_halide_error_buffer_extents_too_large', 'number', ['number', 'number', 'number', 'number']);
    let custom_halide_error_constraint_violated = Module.cwrap('custom_halide_error_constraint_violated', 'number', ['number', 'number', 'number', 'number', 'number']);
    let custom_halide_error_host_is_null = Module.cwrap('custom_halide_error_host_is_null', 'number', ['number', 'number']);
    let custom_halide_upgrade_buffer_t = Module.cwrap('custom_halide_upgrade_buffer_t', 'number', ['number', 'number', 'number', 'number']);

    let get_halide_buffer_data = Module.cwrap('get_halide_buffer_data', 'number', ['number']);

    Module.print(`halideBuf data address = 0x${get_halide_buffer_data(halideBuf).toString(16)}`);
    let halideBufDataBytePtr = get_halide_buffer_data(halideBuf);
    Module.print('halideBuf data in wasm memory:');
    Module.print(new Uint8Array(Module.wasmMemory.buffer).slice(halideBufDataBytePtr, halideBufDataBytePtr + width * height));

    WebAssembly.instantiateStreaming(fetch('bin/myfunc.wasm'), {
        env: {
            memory: Module.wasmMemory,
            halide_downgrade_buffer_t: custom_halide_downgrade_buffer_t,
            halide_downgrade_buffer_t_device_fields: custom_halide_downgrade_buffer_t_device_fields,
            halide_error_bad_type: custom_halide_error_bad_type,
            halide_error_buffer_allocation_too_large: custom_halide_error_buffer_allocation_too_large,
            halide_error_buffer_argument_is_null: custom_halide_error_buffer_argument_is_null,
            halide_error_buffer_extents_negative: custom_halide_error_buffer_extents_negative,
            halide_error_buffer_extents_too_large: custom_halide_error_buffer_extents_too_large,
            halide_error_constraint_violated: custom_halide_error_constraint_violated,
            halide_error_host_is_null: custom_halide_error_host_is_null,
            halide_upgrade_buffer_t: custom_halide_upgrade_buffer_t
        }
    })
    .then(myFuncWasm => {
        let myFuncRetStatus = myFuncWasm.instance.exports.myfunc(halideBuf);
        Module.print(`myFunc return status: ${myFuncRetStatus}`);
        Module.print('halideBuf data in wasm memory:');
        Module.print(new Uint8Array(Module.wasmMemory.buffer).slice(halideBufDataBytePtr, halideBufDataBytePtr + width * height));
    });
}
var Module = { // Note: have to use var rather than let, for compatability with emscripten
    onRuntimeInitialized: () => {
        let srcCtx = document.getElementById('canvas-image-src').getContext('2d');
        let outCtx = document.getElementById('canvas-image-out').getContext('2d');
        let img = new Image();
        img.addEventListener('load', () => {
            let width = 512;
            let height = 512;
            srcCtx.drawImage(img, 0, 0, width, height);
            let srcImageData = srcCtx.getImageData(0, 0, width, height);
            let outImageDataArray = new Uint8ClampedArray(srcImageData.data);
            // Set green and blue channel to red channel:
            for(let i = 0; i < outImageDataArray.length; i += 4)
            {
                outImageDataArray[i + 1] = outImageDataArray[i];
                outImageDataArray[i + 2] = outImageDataArray[i];
            }
            let outImageData = new ImageData(outImageDataArray, width, height);
            console.log(outImageData);
            outCtx.putImageData(outImageData, 0, 0);

            const outputWidth = 8;
            const outputHeight = 4;
            let data = new Uint8Array(outputWidth * outputHeight);
            data[0] = 6;
            data[1] = 12;
            data[2] = 18;
            data[outputWidth * outputHeight - 1] = 24;
            let dataHeapBytePtr = Module._malloc(data.length * data.BYTES_PER_ELEMENT);
            console.log(dataHeapBytePtr);
            Module.HEAPU8.set(data, dataHeapBytePtr);
            let run_demo = Module.cwrap('run_demo', 'number', ['number', 'number', 'number']);
            let halideBufPtr = run_demo(dataHeapBytePtr, outputWidth, outputHeight);

            halide_myfunc(Module, halideBufPtr, outputWidth, outputHeight);

            // TODO: Module._free data after demo is complete. This will require a callback, since
            // run_demo runs async code.
        });
        img.src = 'foden-truck.jpg';
    }
};
</script>
<script src="bin/index.js"></script>
</body>
</html>
